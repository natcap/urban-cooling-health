---
title: "Untitled"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---

# Set up

```{r include=FALSE}

### To clear your environment
remove(list = ls())


library(dplyr)
library(tidyr)
library(stringr)

library(ggplot2)
```



# Load data



cur   current/baseline climate
fut   future climate (2050 or 2070)
--
MAT   Mean annual temperature
MTWM  Maximum temperature of the *warmest* month
MTCM  Minimum temperature of the *coldest* month
AP    Annual precipitation
PDQ   Precipitation of the driest quarter


## Global data

### temp 

```{r}

dir <- "G:/Shared drives/Wellcome Trust Project Data/0_source_data/Climate-urban-forests/"

f <- paste0(dir, "2_cities_climate_exposure.csv")

city_climate <- readr::read_csv(f, show_col_types = F) 

c_climate <- city_climate %>%
  filter(city == 'London') %>%
  select(cur_MTWM,	fut_MTWM_2050_45,	fut_MTWM_2070_45) %>%
  gather(key = 'var', value = 'value') %>%
  mutate(var = gsub('_MTWM|_45|fut_MTWM_', '', var)) %>%
  mutate(var = ifelse(var == 'cur', 'Baseline', var)) %>%
  mutate(var = factor(x = var, levels = c('Baseline', '2050', '2070')))



## plot
c_climate %>%
  ggplot(aes(x = var, y = value, fill = value)) + 
  geom_col(show.legend = F) +
  labs(x = NULL, y = expression("Temperature ("*~degree*C*")"), 
       title = "Max temperature of the warmest month \nin London, UK") +
  # scale_fill_distiller(palette = "YlOrBr", direction = 1) +
  scale_fill_gradient(low = "#fed98e", high = "#d95f0e") +  # Lighter to moderate orange
  coord_cartesian(ylim = c(20, 25)) +
  geom_text(aes(label = round(value, 1)), vjust = -0.5, size = 4) +  # Add value labels
  theme_minimal(base_size = 18) +
  theme(plot.title = element_text(hjust = 0.5))

f <- "./figures/temp_scenario.png"
ggsave(f, plot = last_plot(), width = 6, height = 7, units = "in", dpi = 300)
```


### species at risk

If the exposure to future climate is greater than the current safety margin for the focal species in a focal city (that is, *high risk*), then 
  R > 0 for MAT and MTWM and 
  R < 0 for MTCM, AP and PDQ.
  
  

```{r}

f <- paste0(dir, "5_results_complete.csv")

spe <- readr::read_csv(f, show_col_types = F) 
names(spe)

spe_climate <- spe %>%
  filter(city == 'London') %>%
  select(1:family, 
         matches("MTWM|safety|risk", ignore.case = F) ) %>%
  select(-matches("MAT_|PDQ|_AP|_MAT|_60"))

names(spe_climate)


## 
spe_at_risk <- spe %>%
  filter(city == 'London') %>%
  select(1:family, 
         matches("risk", ignore.case = F) ) %>%
  select(-matches("_60")) %>%
  
  filter(
    risk_MAT_95_2050_45 >0   | risk_MAT_95_2070_45 > 0 | 
      risk_MTWM_95_2050_45>0 | risk_MTWM_95_2070_45>0 |
      risk_AP_95_2050_45 < 0 | risk_AP_95_2070_45<0 |
      risk_PDQ_95_2050_45<0  | risk_PDQ_95_2070_45<0
  ) %>%
  gather(key = 'var', value = 'value', 5:ncol(.)) %>%
  mutate(year = str_extract(var, "20(50|70)"),     # extract "2030", "2040", or "2050"
         year = as.numeric(year))  %>%
  filter(year == 2050)


unique(spe_at_risk$var)
names(spe_at_risk)

spe_at_risk_unique <- spe_at_risk %>%
  distinct(country, city, species, family)

```



## London tree data

```{r eval=FALSE, include=FALSE}

library(sf)

dir_tree <- "G:/Shared drives/Wellcome Trust Project Data/0_source_data/GiGL land use data/GiGL_Trees_font_point/"

f <- paste0(dir_tree, 'GiGL_GLATrees_Pre2023.shp')

tree <- st_read(f, quiet = TRUE)

tree_sub <- tree %>%
  select(-c(SortOrder, RecMonSta:StatusLISI, SurveyName:SurveyRef, PrivateLoc, PrivateCod,
            RecOccKey:VersionDt))


f <- paste0('./data/', 'GiGL_GLATrees_Pre2023_sub.rds')
saveRDS(object = tree_sub, file = f)
```




```{r load data subset}

f <- paste0('./data/', 'GiGL_GLATrees_Pre2023_sub.rds')
tree_sub <- readRDS(f)

names(tree_sub)

tree1_gigl <- tree_sub %>%
  distinct(TaxonName, CommonName, TaxonRank, TaxonGroup, TaxonCat, CommonGrp, TaxonClass, TaxonOrder, TaxonFamil, GroupOrder) %>%
  st_drop_geometry()
```



## Identify at-risk trees by name matching 

```{r - taxize}
# install.packages("remotes")
# remotes::install_github("ropensci/taxize")


library("taxize")
# resolved <- gnr_resolve(names = c("Quercus robur", "Pinus sylvestris"))



## Match the two dataset: 
# --> tree2_clim
# --> tree1_gigl

tree2_clim <- spe_at_risk_unique
  


## merge two data - a test 
tree_com1 <- left_join(
  tree1_gigl, 
  tree2_clim,
  by = c('TaxonName' = 'species')
)



## matched data 1
tree_com1_matched <- tree_com1 %>%
  filter(!is.na(city))


nrow(tree_com1) - nrow(tree_com1_matched)



## for unmatched ones -- find unified name for further matching 

## for data 1 --- 
tree1_0 <- tree1_gigl %>%
  filter(!TaxonName %in% unique(tree_com1_matched$TaxonName) ) %>%
  separate(col = TaxonName, into = c("TaxonName1", "TaxonName2"), sep = "=", remove = F) %>%
  mutate(TaxonName1 = trimws(TaxonName1),
         TaxonName2 = trimws(TaxonName2))

tree1_1 <- gna_verifier(tree1_0$TaxonName1)

tree1_1_matched <- tree1_1 %>%
  filter(!is.na(matchedName))

tree1_1_tbd <- tree1_0 %>%
  filter(!TaxonName1 %in% unique(tree1_1_matched$submittedName)) %>%
  mutate(TaxonName3 = paste0(TaxonName1, ' (', TaxonName2, ')'),
         TaxonName3 = gsub('\\(NA\\)', '', TaxonName3)) %>%
  select(1:TaxonName2, TaxonName3, everything())

tree1_2 <- gna_verifier(tree1_1_tbd$TaxonName2)
tree1_3 <- gna_verifier(tree1_1_tbd$CommonName)
tree1_4 <- gna_verifier(tree1_1_tbd$TaxonName3)


## for data 2 ---

tree2_0 <- tree2_clim %>%
  filter(!species %in% unique(tree_com1$TaxonName) ) 

tree2_1 <- gna_verifier(tree2_0$species)
tree2_1_matched <- tree2_1 %>%
  filter(!is.na(matchedName)) %>%
  select(submittedName, matchedNameID, matchedName, currentNameId)


## merge again 

tree_com2 <- left_join(
  tree1_1_matched, 
  tree2_1_matched,
  by = 'matchedNameID', ## 0 match
)


tree_com2_matched <- tree_com2 %>%
  filter(!is.na(matchedName.y))
```


```{r - final list}
## final data
tree_risk_london <- rbind(tree_com1_matched, tree_com2_matched)

f <- paste0("./data/", "GiGL_GLATrees_Pre2023_at_risk.rds")
f <- paste0("./data/", "GiGL_GLATrees_Pre2023_at_risk.csv")

readr::write_csv(x = tree_risk_london, f)
```





