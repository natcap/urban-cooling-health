---
title: "Untitled"
output: html_document
date: "2025-09-16"
---


-->
--> Note: run the `invest_result_zonal_viz_1_temp.Rmd` first, before run this script. 
--> 


## AOI

```{r - borough}

#' borough level
f <- file.path(dir.aoi, 'London_Borough_aoi.shp')
aoi <- st_read(f, quiet = T) %>% select(GSS_CODE)

```


```{r - lsoa}

#' lsoa data with quintiles info, which was generated by `socio-economic-data-ES-equity.Rmd`
f <- './data/Social_Vulnerability_Index_london_q.gpkg'
aoi_lsoa <- st_read(f, quiet = T) %>%
  rename('GSS_CODE' = 'id') %>%
  mutate(GSS_CODE = as.character(GSS_CODE)) %>%
  select(GSS_CODE)

```


## Energy saving - select one input

  `avd_eng_cn` - (optional) Avoided energy consumption (kWh or $ if optional energy cost input column was provided in the Energy Consumption Table).

### ? Pick one scale ---

### Load data - borough level 

```{r}

sp_scale = "borough"
ind <- 'energy_sav_sum' # --> sum or average
ind_scale <- 1/10^6  # convert to million
ind_label <- "avoided energy cost (Million £)"


#' load data generated from `invest_result_zonal_stats_viz_temp.Rmd`
# f <- paste0('./data/', 'ucm_output_shp_all_df.rds'); f # old name
f <- paste0('./data/', 'ucm_output_shp_stats_outcomes_by_borough.rds'); f # new name
shp_all_df <- readRDS(f) %>%
  rename(ind = 'avd_eng_cn')

# 1. calculate the change from year i
df_stats_i0 <- func_calculate_change_from_yri_lc0(data = shp_all_df, aoi = aoi)
df_chg_sf_i0<- func_calculate_change_from_yri_lc0(data = shp_all_df, aoi = aoi, return_sf = T)


# 2. also calculate the change from year 0
df_stats_00 <- func_calculate_change_from_yr0_lc0(data = shp_all_df, aoi = aoi)

# 3. and combine the two change calculations  
stat_both_l <- func_combine_two_change_dfs(df_stats_00, df_stats_i0)

```


### Load data - lsoa level 

```{r eval=FALSE, include=FALSE}
sp_scale = "lsoa"
ind <- "energy_sav_sum"; 
# ind <- "energy_sav_mean"
ind_scale <- 1/10^6  # convert to million
ind_label <- "avoided energy cost (Million £)"

f <- paste0('./data/', 'ucm_output_shp_stats_energy_by_lsoa.rds'); f
shp_all_df <- readRDS(f) %>%
  rename('GSS_CODE' = 'LSOA_CODE') %>% # rename to be able to use the function 
  mutate(GSS_CODE = as.character(GSS_CODE))

# 1. calculate the change from year i
df_stats_i0 <- func_calculate_change_from_yri_lc0(data = shp_all_df, aoi = aoi_lsoa)
df_chg_sf_i0<- func_calculate_change_from_yri_lc0(data = shp_all_df, aoi = aoi_lsoa, return_sf = T)


# 2. also calculate the change from year 0
df_stats_00 <- func_calculate_change_from_yr0_lc0(data = shp_all_df, aoi = aoi_lsoa)

# 3. and combine the two change calculations  
stat_both_l <- func_combine_two_change_dfs(df_stats_00, df_stats_i0)
```


### Re-code Land scenario

```{r}
## re-code land scenario labels
df_stats_i0 <- df_stats_i0 %>%
  mutate(lc_scenario = factor(lc_scenario, 
                              levels = names(scenario_labels),
                              labels = unname(scenario_labels)))
stat_both_l <- stat_both_l %>%
  mutate(lc_scenario = factor(lc_scenario, 
                              levels = names(scenario_labels),
                              labels = unname(scenario_labels)))

```




## Viz 

  Run either data from the above and then run viz starting from here...
  

```{r - plot - line}

## plot change from year i, old plot 
func_plot_line(data = df_stats_i0 %>% filter(year >= year_baseline))

## plot change from year i 
func_plot_change_point(data = stat_both_l, level = sp_scale, plot_avg = F)
func_plot_change_point(data = stat_both_l, level = sp_scale, plot_h = 4, plot_avg = T)

```


```{r - plot - map}

df_chg_sf_i0_input <- df_chg_sf_i0 %>% 
  filter(year > year_baseline) %>%
  mutate(year = as.factor(year)) %>%
  mutate(lc_scenario = factor(lc_scenario, 
                              levels = names(scenario_labels),
                              labels = unname(scenario_labels)))

## save a copy for viz
f <- paste0('./data/', 'viz_sf_', ind, '_lc_effect_', sp_scale, '.rds'); f
# "./data/viz_sf_avd_eng_cn_lc_effect.rds"
saveRDS(df_chg_sf_i0_input, f)


## apply the function 
func_plot_map(data = df_chg_sf_i0_input, level = sp_scale)
```

 # -----------------------------------------------------------------------------
 #                                      STOP HERE
 # -----------------------------------------------------------------------------


 ### Heavy work productivity loss [OLD model]

  **!!!** please refer to `invest_result_zonal_viz_pd_NEW.Rmd`

  `avg_hvls_v` - (optional) Heavy work productivity loss (%).

  - data stats
   
```{r eval=FALSE, include=FALSE}

ind <- 'avg_hvls_v'
ind_scale <- -1  ## reverse for easier the interpretation: "productivity loss" --> "productivity gain"
ind_label <- "heavy work productivity (%)"


# 1. calculate the change from year i
df_stats_i0 <- func_calculate_change_from_yri_lc0(data = shp_all_df)
df_chg_sf_i0<- func_calculate_change_from_yri_lc0(data = shp_all_df, return_sf = T)


# 2. also calculate the change from year 0
df_stats_00 <- func_calculate_change_from_yr0_lc0(data = shp_all_df)

# 3. and combine the two change calculations  
stat_both_l <- func_combine_two_change_dfs(df_stats_00, df_stats_i0)

```
  
  
  
 - plot - line
 
```{r eval=FALSE, include=FALSE}

## plot change from year i, old plot 
func_plot_line(data = df_stats_i0 %>% filter(year >= year_baseline))

## plot change from year i 
func_plot_change_point(data = stat_both_l, plot_avg = F)
func_plot_change_point(data = stat_both_l, plot_avg = T)

```


 - plot - map
 
```{r eval=FALSE, include=FALSE}

df_chg_sf_i0_input <- df_chg_sf_i0 %>% 
  filter(year > year_baseline) %>%
  mutate(year = as.factor(year)) 


## apply the function 
func_plot_map(data = df_chg_sf_i0_input)

```

